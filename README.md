# Summary

The steps outlined below describe a fully automated process of connecting to a weather station that transmits streaming data generated by sensors, processing these data, and saving the transformed output to a file.  Data extraction process is continuous.  Once new data is transmitted, it is processed and appended to a file.  Thus, the file is being continuously updated with new data.

# Data Acquisition

Below is an example of the streaming measurements coming from the weather station:

```
1419408015	0R1,Dn=059D,Dm=066D,Dx=080D,Sn=8.5M,Sm=9.5M,Sx=10.3M
1419408016	0R1,Dn=059D,Dm=065D,Dx=078D,Sn=8.5M,Sm=9.5M,Sx=10.3M
1419408016	0R2,Ta=13.9C,Ua=28.5P,Pa=889.9H
1419408017	0R1,Dn=059D,Dm=064D,Dx=075D,Sn=8.7M,Sm=9.6M,Sx=10.3M
1419408018	0R1,Dn=059D,Dm=064D,Dx=075D,Sn=8.9M,Sm=9.6M,Sx=10.3M
1419408019	0R1,Dn=059D,Dm=065D,Dx=075D,Sn=8.8M,Sm=9.5M,Sx=10.3M
```

Each line consists of a timestamp and a set of measurements.  Each measurement has an abbreviation, such as Dn, Dm, Sn, etc.  The dictionary of all the abbreviations is provided below:

```
Sn      Wind speed minimum m/s, km/h, mph, knots #,M, K, S, N
Sm      Wind speed average m/s, km/h, mph, knots #,M, K, S, N
Sx      Wind speed maximum m/s, km/h, mph, knots #,M, K, S, N
Dn      Wind direction minimum deg #, D
Dm      Wind direction average deg #, D
Dx      Wind direction maximum deg #, D
Pa      Air pressure hPa, Pa, bar, mmHg, inHg #, H, P, B, M, I
Ta      Air temperature °C, °F #, C, F
Tp      Internal temperature °C, °F #, C, F
Ua      Relative humidity %RH #, P
Rc      Rain accumulation mm, in #, M, I
Rd      Rain duration s #, S
Ri      Rain intensity mm/h, in/h #, M, I
Rp      Rain peak intensity mm/h, in/h #, M, I
Hc      Hail accumulation hits/cm2, hits/in2, hits #, M, I, H
Hd      Hail duration s #, S
Hi      Hail intensity hits/cm2h, hits/in2h, hits/ h #, M, I, H
Hp      Hail peak intensity hits/cm2h, hits/in2h, hits/ h #, M, I, H
Th      Heating temperature °C, °F #, C, F
Vh      Heating voltage V #, N, V, W, F2
Vs      Supply voltage V V
Vr      3.5 V ref. voltage V V
```

In a discussion that follows, the data for the average wind direction (which has an abbreviation Dm) is extracted, processed and recorded to a file.

First, we define a function that parses each line of the streaming data (such as `1419408015	0R1,Dn=059D,Dm=066D,Dx=080D,Sn=8.5M,Sm=9.5M,Sx=10.3M`) and returns the average wind direction (Dm):

```python
import re

def parse(line):

    match = re.search("Dm=(\d+)", line)
    if match:
        val = match.group(1)
        return [int(val)]
        
    return []
```

Next, we import and create a new instance of Spark's StreamingContext:

```python
from pyspark.streaming import StreamingContext
ssc = StreamingContext(sc, 1)                                
```

The argument sc is the SparkContext, and 1 specifies a batch interval of one second (i.e., each sliding 10-second window as defined below will have approximately 10 lines of data).

A connection to the streaming weather data is opened as follows:

```python
lines = ssc.socketTextStream("rtd.hpwren.ucsd.edu", 12020)
```

This create a new variable `lines` to be a Spark DStream that streams the lines of output from the weather station.

Then we read the average wind speed from each line and store it in a new DStream `vals`:

```python
vals = lines.flatMap(parse)
```

The flatMap() function iterates over the lines transmitted by the sensors, and calls the parse() function defined above in order to extract the average wind speed from each line.

Next, we create a sliding window over the measurements by calling the window() method:

```python
window = vals.window(10, 5)
```

This creates a sliding window that combines the ten seconds worth of data and moves by five seconds.

# Data Transformation and Loading
We have already started transforming the data transmitted by the weather station when we extracted the average wind direction from each line obtained from the station's sensors.  We would like to futher process the data on average wind direction to find the minimum and maximum values in our 10-second window. The following function prints all the values of the average wind direction  within a window along with the minimum and maximum of these values to the screen and outputs the same values to a file:

```python
def stats(rdd):
    
    print(rdd.collect())
    print(rdd.collect(), file = open('/Users/eagronin/Documents/Data Science/Portfolio/Project Output/Spark Output/wind_direction_streaming.txt', 'a'))
        
    if rdd.count() > 0:
        print("max = {}, min = {}".format(rdd.max(), rdd.min()))
        print("max = {}, min = {}".format(rdd.max(), rdd.min()), file = open('/Users/eagronin/Documents/Data Science/Portfolio/Project Output/Spark Output/wind_direction_streaming.txt', 'a'))
```

The first `print()` command in the function above outputs the contents of the RDD (which, in our case, are the observations on average wind direction collected during a 10-second interval) into the screen, while the second `print()` command outputs the same contents into a file `wind_direction_streaming.txt`.  The command below opens the file for writing:
        
```python        
file = open('/Users/eagronin/Documents/Data Science/Portfolio/Project Output/Spark Output/wind_direction_streaming.txt', 'w')
```

Next, we call the stats() function for each RDD in our sliding window:

```python
window.foreachRDD(lambda rdd: stats(rdd))
```

All the calls to the `stats()` function append (rather than overwirte) new data to `wind_direction_streaming.txt`.

We begin the process of reading and processing the data from the weather station by calling `start()` on the `StreamingContext`:

```python
ssc.start()
```

The output starts appearing on the screen and is being written to the file `wind_direction_streaming.txt':

```
[295, 294, 294, 293]
max = 295, min = 293
[295, 294, 294, 293, 293, 293, 292, 291, 290]
max = 295, min = 290
[293, 293, 292, 291, 290, 292, 291, 289, 287, 286]
max = 293, min = 286
[292, 291, 289, 287, 286, 285, 285, 285, 285, 288]
max = 292, min = 285
[285, 285, 285, 285, 288, 287, 289, 293, 297, 300]
max = 300, min = 285
...
```

As discussed above, the sliding window contains ten seconds worth of data and slides every five seconds. In the beginning, the number of values in the windows are increasing as the data accumulates.  After the third window, the size stays approximately the same. Because the window slides half as often as the size of the window, the second half of a window becomes the first half of the next window. For example, the second half of the fourth window is 285, 285, 285, 285, 288, which becomes the first half of the fifth window.

We stop the process of reading the data from the weather station by calling `stop()` on the `StreamingContext`:

```python
ssc.stop()
```

# Conclusion

The steps outlined above provide a fully automated framework for connecting to a source that transmits streaming data generated by sensors, processing these data, and outputing the processed data to a file.
